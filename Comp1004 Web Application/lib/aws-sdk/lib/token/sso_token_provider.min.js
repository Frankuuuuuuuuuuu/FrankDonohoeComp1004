/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/aws-sdk@2.1342.0/lib/token/sso_token_provider.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var AWS=require("../core"),crypto=require("crypto"),fs=require("fs"),path=require("path"),iniLoader=AWS.util.iniLoader,lastRefreshAttemptTime=0,validateTokenKey=function(e,r){if(!e[r])throw AWS.util.error(new Error('Key "'+r+'" not present in SSO Token'),{code:"SSOTokenProviderFailure"})},refreshUnsuccessful=function(e,r,i){if(!(r>e))throw AWS.util.error(new Error('SSO Token refresh failed. Please log in using "aws sso login"'),{code:"SSOTokenProviderFailure"});i(null)};AWS.SSOTokenProvider=AWS.util.inherit(AWS.Token,{expiryWindow:300,constructor:function(e){AWS.Token.call(this),e=e||{},this.expired=!0,this.profile=e.profile||process.env.AWS_PROFILE||AWS.util.defaultProfile,this.get(e.callback||AWS.util.fn.noop)},load:function(e){var r=this,i=iniLoader.loadFrom({isConfig:!0})[this.profile]||{};if(0===Object.keys(i).length)throw AWS.util.error(new Error('Profile "'+this.profile+'" not found'),{code:"SSOTokenProviderFailure"});if(!i.sso_session)throw AWS.util.error(new Error('Profile "'+profileName+'" is missing required property "sso_session".'),{code:"SSOTokenProviderFailure"});var o=i.sso_session,s=iniLoader.loadSsoSessionsFrom()[o];if(!s)throw AWS.util.error(new Error('Sso session "'+o+'" not found'),{code:"SSOTokenProviderFailure"});if(!s.sso_start_url)throw AWS.util.error(new Error('Sso session "'+profileName+'" is missing required property "sso_start_url".'),{code:"SSOTokenProviderFailure"});if(!s.sso_region)throw AWS.util.error(new Error('Sso session "'+profileName+'" is missing required property "sso_region".'),{code:"SSOTokenProviderFailure"});var n=crypto.createHash("sha1").update(o).digest("hex")+".json",t=path.join(iniLoader.getHomeDir(),".aws","sso","cache",n),a=JSON.parse(fs.readFileSync(t));if(!a)throw AWS.util.error(new Error('Cached token not found. Please log in using "aws sso login" for profile "'+this.profile+'".'),{code:"SSOTokenProviderFailure"});validateTokenKey(a,"accessToken"),validateTokenKey(a,"expiresAt");var l=AWS.util.date.getDate().getTime(),c=new Date(l+1e3*this.expiryWindow),f=new Date(a.expiresAt);if(f>c)return r.token=a.accessToken,r.expireTime=f,r.expired=!1,void e(null);if(l-lastRefreshAttemptTime<3e4)refreshUnsuccessful(l,f,e);else{validateTokenKey(a,"clientId"),validateTokenKey(a,"clientSecret"),validateTokenKey(a,"refreshToken"),r.service&&r.service.config.region===s.sso_region||(r.service=new AWS.SSOOIDC({region:s.sso_region}));var u={clientId:a.clientId,clientSecret:a.clientSecret,refreshToken:a.refreshToken,grantType:"refresh_token"};lastRefreshAttemptTime=AWS.util.date.getDate().getTime(),r.service.createToken(u,(function(i,o){if(i||!o)refreshUnsuccessful(l,f,e);else try{validateTokenKey(o,"accessToken"),validateTokenKey(o,"expiresIn"),r.expired=!1,r.token=o.accessToken,r.expireTime=new Date(Date.now()+1e3*o.expiresIn),e(null);try{a.accessToken=o.accessToken,a.expiresAt=r.expireTime.toISOString(),a.refreshToken=o.refreshToken,fs.writeFileSync(t,JSON.stringify(a,null,2))}catch(e){}}catch(r){refreshUnsuccessful(l,f,e)}}))}},refresh:function(e){iniLoader.clearCachedFiles(),this.coalesceRefresh(e||AWS.util.fn.callback)}});
//# sourceMappingURL=/sm/b7c3ed6fd1c1dbb6687f619931b959bb2adc43a017c43b509a57e34d5897c7c0.map